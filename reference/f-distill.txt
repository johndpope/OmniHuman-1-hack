License: arXiv.org perpetual non-exclusive license
arXiv:2502.15681v1 [cs.LG] 21 Feb 2025
One-step Diffusion Models with 
f
-Divergence Distribution Matching
Yilun Xu
NVIDIA yilunx@nvidia.com
Weili Nie
NVIDIA wnie@nvidia.com
Arash Vahdat
NVIDIA avahdat@nvidia.com
Abstract
Sampling from diffusion models involves a slow iterative process that hinders their practical deployment, especially for interactive applications. To accelerate generation speed, recent approaches distill a multi-step diffusion model into a single-step student generator via variational score distillation, which matches the distribution of samples generated by the student to the teacher‚Äôs distribution. However, these approaches use the reverse Kullback‚ÄìLeibler (KL) divergence for distribution matching which is known to be mode seeking. In this paper, we generalize the distribution matching approach using a novel 
f
-divergence minimization framework, termed 
f
-distill, that covers different divergences with different trade-offs in terms of mode coverage and training variance. We derive the gradient of the 
f
-divergence between the teacher and student distributions and show that it is expressed as the product of their score differences and a weighting function determined by their density ratio. This weighting function naturally emphasizes samples with higher density in the teacher distribution, when using a less mode-seeking divergence. We observe that the popular variational score distillation approach using the reverse-KL divergence is a special case within our framework. Empirically, we demonstrate that alternative 
f
-divergences, such as forward-KL and Jensen-Shannon divergences, outperform the current best variational score distillation methods across image generation tasks. In particular, when using Jensen-Shannon divergence, 
f
-distill achieves current state-of-the-art one-step generation performance on ImageNet64 and zero-shot text-to-image generation on MS-COCO. Project page: https://research.nvidia.com/labs/genair/f-distill/

1Introduction
Diffusion models [12, 58] are transforming generative modeling in visual domains, with impressive success in generating images [43, 44, 1], videos [13, 53], 3D objects [32, 75], motion [76, 74], etc. However, one of the key limitations of deploying diffusion models in real-world applications is their slow and computationally expensive sampling process that involves calling the denoising neural network iteratively.

Early works on accelerating diffusion models relied on better numerical solvers for solving the ordinary differential equations (ODEs) or stochastic differential equations (SDEs) that describe the sampling process of diffusion models [54, 15, 29, 17, 67]. However, these methods can only reduce the number of sampling steps to around tens of steps, due to the discretization error, accumulated with fewer steps.

More recently, distillation-based approaches aim at the ambitious goal of reducing the number of sampling steps to a single network call. These approaches can be generally grouped into two categories: 1) trajectory distillation [59, 55, 9, 23, 28] which distills the deterministic ODE mapping between noise and data intrinsic in a diffusion model to a one-step student, and 2) distribution matching approaches [72, 71, 79, 82] that ignore the deterministic mappings, and instead, matches the distribution of samples generated by a one-step student to the distribution imposed by a pre-trained teacher diffusion model. Among the two categories, the latter often performs better in practice as the deterministic mapping between noise and data is deemed complex and hard to learn. Naturally, the choice of divergence in distribution matching plays a key role as it dictates how the student‚Äôs distribution is matched against the teacher‚Äôs. Existing works [72, 71] often use variational score distillation [64] that matches the distribution of the student and teacher by minimizing the reverse-KL divergence. However, this divergence is known to be mode-seeking [2] and can potentially ignore diverse modes learned by the diffusion model.

Refer to caption
Figure 1:The gradient update for the one-step student in 
f
-distill. The gradient is a product of the difference between the teacher score and fake score, and a weighting function determined by the chosen 
f
-divergence and density ratio. The density ratio is readily available from the discriminator in the auxiliary GAN objective.
In this work, we propose a novel generalization of the distribution matching distillation approach using the 
f
-divergence, termed 
f
-distill. The 
f
-divergence represents a large family of divergences including reverse-KL, forward-KL, Jensen-Shannon (JS), squared Hellinger, etc. These divergences come with different trade-offs on how they penalize the student for missing modes in the teacher distribution and how they can be estimated and optimized using Monte Carlo sampling. Within our framework, we evaluate various 
f
-divergences based on these properties and observe different tradeoff. For instance, forward-KL has a better mode coverage, but has a large gradient variance; JS demonstrates moderate mode-seeking and gradient saturation, particularly in early training stages, but exhibits low variance. Our analysis reveals that no single 
f
-divergence consistently outperforms others across all datasets. We observe divergences with better mode coverage tendencies generally perform better on the CIFAR-10 dataset. However, on large-scale challenging datasets like ImageNet-64 and text-to-image generation with Stable Diffusion (SD), divergences with lower variance achieve superior results.

Refer to caption
Figure 2:Score difference and the weighting function on a 2D example. 
h
 is the weighting function in forward-KL. Observe that the teacher and fake scores often diverge in lower-density regions (darker colors in the bottom left figure indicate larger score differences), where larger estimation errors occur. The weighting function downweights these regions (lighter colors in the bottom right figure) during gradient updates for 
f
-distill.
Our derivation of the 
f
-divergence distribution matching shows that the gradient of the objectives is the product of the difference in score between teacher and student (which also exists in prior works), and a weighting function that depends on density ratio and the chosen 
f
-divergence (new in this work), as illustrated in Fig. 1. The density ratio can be readily obtained from the discriminator in the commonly used auxiliary GAN objective. We show that the previous DMD approach is a special case of our approach that corresponds to a constant weighting. We discuss how the newly derived weighting coefficient influences the tradeoffs discussed above and propose normalization techniques for stabilizing divergences with higher gradient variance. As shown in Fig. 2, we observe that the weight coefficient for 
f
-divergences with less mode-seeking tendency will downweight the score difference in the areas where the teacher has low density. This is in line with the recent observation that score estimation in low-density regions can be inaccurate [18], and it allows our model to adaptively rely less on matching its score with the teacher‚Äôs unreliable score on such regions.

Empirically, we validate the 
f
-distill framework on several image generation tasks. Quantitative results demonstrate that the less mode-seeking divergences in 
f
-distill consistently outperform previous best variational score distillation approaches. Notably, by minimizing the less mode-seeking and lower gradient variance Jensen-Shannon divergences, 
f
-distill achieves new state-of-the-art one-step generation performance on ImageNet-64 and zero-shot MS-COCO (using SD v1.5). Furthermore, our experiments confirm that the weighting function effectively assigns smaller weights to regions with larger score differences.

Contributions. (i) We propose a novel generalization of distribution matching distillation using 
f
-divergence, allowing flexibility in how the student distribution is matched against the teacher‚Äôs. (ii) We discuss different trade-offs with different choices of 
f
-divergence in terms of mode seeking, gradient saturation and variance. (iii) We provide practical guidelines on reducing the variance of gradient and estimating different terms in the objective efficiently. (iv) We empirically show that our proposed 
f
-distill achieves the state-of-the-art FID score in one-step generation on the ImageNet-64 and zero-shot MS-COCO text-to-image benchmark.

2Background
2.1Diffusion models
The goal of 
f
-distill is to accelerate the generation of pre-trained (continuous-time) DMs [58, 12]. In this paper, we follow the popular EDM framework [17] for the notations and forward/backward processes. DMs perturb the clean data 
ùê±
0
‚àº
p
data
 in a fixed forward process using 
œÉ
2
‚Å¢
(
t
)
-variance Gaussian noise, where 
ùê±
0
‚àà
‚Ñù
d
 and 
t
 denotes the time along the diffusion process. The resulting intermediate distribution is denoted as 
p
t
‚Å¢
(
ùê±
t
)
 with 
ùê±
t
‚àà
‚Ñù
d
. For notation simplicity, we will use 
ùê±
 to replace 
ùê±
t
, unless stated otherwise, throughout the paper. For sufficiently large 
œÉ
max
, this distribution is almost identical to pure random Gaussian noise. DMs leverage this observation to sample the initial noise 
œµ
max
‚àº
ùí©
‚Å¢
(
ùüé
,
œÉ
max
2
‚Å¢
ùë∞
)
, and then iteratively denoise the sample by solving the following backward ODE/SDE, which guarantees that if 
œÉ
‚Å¢
(
0
)
=
0
, the final 
ùê±
 follows the data distribution 
p
data
:

d
‚Å¢
ùê±
=
‚àí
œÉ
Àô
‚Å¢
(
t
)
‚Å¢
œÉ
‚Å¢
(
t
)
‚Å¢
‚àá
ùê±
log
‚Å°
p
t
‚Å¢
(
ùê±
)
‚Å¢
d
‚Å¢
t
‚èü
Probability Flow ODE
‚àí
Œ≤
‚Å¢
(
t
)
‚Å¢
œÉ
2
‚Å¢
(
t
)
‚Å¢
‚àá
ùê±
log
‚Å°
p
t
‚Å¢
(
ùê±
)
‚Å¢
d
‚Å¢
t
+
2
‚Å¢
Œ≤
‚Å¢
(
t
)
‚Å¢
œÉ
‚Å¢
(
t
)
‚Å¢
d
‚Å¢
ùùé
t
‚èü
Langevin Diffusion SDE
,
(1)
where 
ùùé
t
 is a standard Wiener process and 
‚àá
ùê±
log
‚Å°
p
t
‚Å¢
(
ùê±
)
 is the score function of the intermediate distribution 
p
t
‚Å¢
(
ùê±
)
. The score function is learned by a neural network 
s
œï
‚Å¢
(
ùê±
;
œÉ
‚Å¢
(
t
)
)
 trained with the denoising score matching objective [62, 56]. In Equation 1, the first term is the Probability Flow ODE, which guides samples from high to low noise levels. The second term is a Langevin Diffusion SDE, which acts as an equilibrium sampler across different noise levels 
œÉ
‚Å¢
(
t
)
, effectively refining the samples and correcting errors during the sampling process [17, 67]. This component can be scaled by the time-dependent parameter 
Œ≤
‚Å¢
(
t
)
. Setting 
Œ≤
‚Å¢
(
t
)
=
0
 leads to pure ODE-based synthesis. However, solving the diffusion ODE and SDE typically involves a considerable number of iterations (often tens or hundreds), posing a significant challenge to the practical deployment of diffusion models. Although different kinds of accelerated samplers for diffusion ODE [54, 29, 17] and SDE [15, 17, 67] have been proposed, they usually still require 
>
20
 sampling steps in practice to produce decent samples.

2.2Variational score distillation
A recent line of works [72, 71] aim to distill the teacher diffusion models 
s
œï
 into a single step generator 
G
Œ∏
, through variational score distillation (VSD), which is originally introduced for test-time optimization of 3D objects [64]. The goal is to enable a student model 
G
Œ∏
 to directly map the noise 
ùê≥
 from the prior distribution 
p
‚Å¢
(
ùê≥
)
=
ùí©
‚Å¢
(
ùê≥
;
ùüé
,
ùë∞
)
 to the clean sample 
ùê±
0
 at 
œÉ
=
0
 using 
ùê±
0
=
G
Œ∏
‚Å¢
(
ùê≥
)
, effectively bypassing the iterative sampling process. Let 
p
œï
 denote the distribution obtained by plugging in pre-trained diffusion models 
s
œï
‚Å¢
(
ùê±
;
œÉ
‚Å¢
(
t
)
)
 in Equation 1, and let 
q
Œ∏
 denote the output distribution by the one-step generator 
G
Œ∏
 (in the following text, we drop the subscript in 
p
œï
 and 
q
Œ∏
 for notation simplicity). Then, the gradient update for the generator can be formulated as follows:

ùîº
t
,
ùê≥
,
œµ
‚Å¢
[
(
s
œï
‚Å¢
(
ùê±
;
œÉ
‚Å¢
(
t
)
)
‚àí
‚àá
ùê±
log
‚Å°
q
Œ∏
‚Å¢
(
ùê±
;
œÉ
‚Å¢
(
t
)
)
)
‚Å¢
‚àá
Œ∏
G
Œ∏
‚Å¢
(
ùê≥
)
]
(2)
where 
ùê±
=
G
Œ∏
‚Å¢
(
ùê≥
)
+
œÉ
‚Å¢
(
t
)
‚Å¢
œµ
 and 
œµ
‚àº
ùí©
‚Å¢
(
ùüé
,
ùë∞
)
. Intuitively, the gradient encourages the generator to produce samples that lie within high-density regions of the data distribution. This is achieved through the teacher score term, 
s
œï
‚Å¢
(
ùê±
;
œÉ
‚Å¢
(
t
)
)
, which guides the generated samples towards areas where the teacher model assigns high probability. To prevent mode collapse, the gradient also incorporates a term that discourages the generator from simply concentrating on a single high-density point in the teacher‚Äôs distribution. This is done by subtracting the score of the student distribution, 
‚àá
ùê±
log
‚Å°
q
Œ∏
‚Å¢
(
ùê±
;
œÉ
‚Å¢
(
t
)
)
. The gradient update is shown to perform distribution matching by minimizing the reverse-KL divergence between the teacher and student distributions [39, 72].

To estimate the score of the student distribution, previous works [64, 72] have employed another fake score network 
s
œà
‚Å¢
(
ùê±
,
œÉ
‚Å¢
(
t
)
)
 to approximate 
‚àá
ùê±
log
‚Å°
q
Œ∏
‚Å¢
(
ùê±
;
œÉ
‚Å¢
(
t
)
)
. The fake score network 
s
œà
‚Å¢
(
ùê±
,
œÉ
‚Å¢
(
t
)
)
 is dynamically updated with the standard denoising score matching loss, where the ‚Äúclean‚Äù samples come from the generator 
G
Œ∏
 during training. Thus, the VSD training alternates between the generator update and the fake score update, with a two time-scale update rule for stabilized training [71]. Additionally, to further close the gap between the one-step generator and the multi-step teacher diffusion model, a GAN loss is applied to the VSD training pipeline [71], where a lightweight GAN classifier takes as input the middle features from the fake score network.

2.3
f
-divergence
In probability theory, an 
f
-divergence [41] quantifies the difference between two probability density functions, 
p
 and 
q
. Specifically, when 
p
 is absolutely continuous with respect to 
q
, the 
f
-divergence is defined as:

D
f
(
p
|
|
q
)
=
‚à´
q
(
ùê±
)
f
(
p
‚Å¢
(
ùê±
)
q
‚Å¢
(
ùê±
)
)
d
ùê±
where 
f
 is a convex function on 
(
0
,
+
‚àû
)
 satisfying 
f
‚Å¢
(
1
)
=
0
. This divergence satisfies several important properties, including non-negativity and the data processing inequality. Many commonly used divergences can be expressed as special cases of the 
f
-divergence by choosing an appropriate function 
f
. These include the forward-KL divergence, reverse-KL divergence, Hellinger distance, and Jensen-Shannon (JS) divergence, as shown in Table 1. In generative learning, 
f
-divergence has been widely applied to popular generative models, such as GANs [37], VAEs [63], energy-based models [73] and diffusion models [60].

3Method: general 
f
-divergence minimization
f
‚Å¢
(
r
)
h
‚Å¢
(
r
)
Mode-seeking?	Saturation?	Variance
reverse-KL	
‚àí
log
‚Å°
r
1
Yes	No	-
softened RKL	
(
r
+
1
)
‚Å¢
log
‚Å°
(
1
2
+
1
2
‚Å¢
r
)
1
r
+
1
Yes	No	Low
Jensen-Shannon	
r
‚Å¢
log
‚Å°
r
‚àí
(
r
+
1
)
‚Å¢
log
‚Å°
r
+
1
2
r
r
+
1
Medium	Yes	Low
squared Hellinger	
1
‚àí
r
1
4
‚Å¢
r
1
2
Medium	Yes	Low
forward-KL	
r
‚Å¢
log
‚Å°
r
r
No	No	High
Jeffreys	
(
r
‚àí
1
)
‚Å¢
log
‚Å°
(
r
)
r
+
1
No	No	High
Table 1:Comparison of different 
f
-divergences as a function of the likelihood ratio 
r
:=
p
‚Å¢
(
ùê±
)
/
q
‚Å¢
(
ùê±
)
In this section, we introduce a general distillation framework, termed 
f
-distill, based on minimizing the 
f
-divergence between the teacher and student distributions. Since the student distribution 
q
 is the push-forward measure induced by the one-step generator 
G
Œ∏
, it implicitly depends on the generator‚Äôs parameters 
Œ∏
. Due to this implicit dependency, directly calculating the gradient of 
f
-divergence, 
D
f
(
p
|
|
q
)
, w.r.t 
Œ∏
 presents a challenge. However, the following theorem establishes the analytical expression for this gradient, revealing that it can be formulated as a weighted version of the gradient employed in variational score distillation. Notably, these weights are determined by the density ratio of the generated samples. We state the theorem more generally by providing the gradient for 
p
t
 and 
q
t
, where 
p
t
 is the perturbed distribution through the diffusion forward process for the teacher‚Äôs distribution 
p
, i.e., 
p
t
=
p
0
‚àó
ùí©
‚Å¢
(
ùüé
,
œÉ
2
‚Å¢
(
t
)
‚Å¢
ùë∞
)
 (same for the student distribution 
q
).

Theorem 1.
Let 
p
 be the teacher‚Äôs generative distribution, and let 
q
 be a distribution induced by transforming a prior distribution 
p
‚Å¢
(
ùê≥
)
 through the differentiable mapping 
G
Œ∏
. Assuming 
f
 is twice continuously differentiable, then the gradient of 
f
-divergence between the two intermediate distribution 
p
t
 and 
q
t
 w.r.t 
Œ∏
 is:

‚àá
Œ∏
D
f
(
p
t
|
|
q
t
)
=
ùîº
ùê≥
,
œµ
‚àí
[
f
‚Ä≤‚Ä≤
(
p
t
‚Å¢
(
ùê±
)
q
t
‚Å¢
(
ùê±
)
)
(
p
t
‚Å¢
(
ùê±
)
q
t
‚Å¢
(
ùê±
)
)
2
(
‚àá
ùê±
log
‚Å°
p
t
‚Å¢
(
ùê±
)
‚èü
teacher score
‚àí
‚àá
ùê±
log
‚Å°
q
t
‚Å¢
(
ùê±
)
‚èü
fake score
)
‚àá
Œ∏
G
Œ∏
(
ùê≥
)
]
(3)
